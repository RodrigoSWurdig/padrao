cubes:
  - name: universal_person
    sql_table: dev.derived.vector_universal_person # Table

    joins:
      - name: universal_job
        relationship: one_to_many
        sql: "{CUBE}.vup_id = {universal_job}.vup_id"
      
      # ENG-1914: Junction table joins for many-to-many identifier relationships
      - name: vup_linkedin_urls
        relationship: one_to_many
        sql: "{CUBE}.vup_id = {vup_linkedin_urls}.vup_id"
      
      - name: vup_fbf_ids
        relationship: one_to_many
        sql: "{CUBE}.vup_id = {vup_fbf_ids}.vup_id"
      
      - name: vup_pdl_ids
        relationship: one_to_many
        sql: "{CUBE}.vup_id = {vup_pdl_ids}.vup_id"

    dimensions:
      - name: id
        sql: vup_id
        type: string
        primary_key: true
        public: true
      
      # ENG-1914: Merge tracking dimension
      - name: merged_into_vup_id
        sql: merged_into_vup_id
        type: string
        description: "If not null, this person was merged into another record"
      
      # ENG-1914: Active person indicator (calculated dimension)
      - name: is_active
        sql: "CASE WHEN {CUBE}.merged_into_vup_id IS NULL THEN 'Yes' ELSE 'No' END"
        type: string
        description: "Whether this is an active person record (not merged)"

      # DEPRECATED: Use junction tables instead (vup_fbf_ids, vup_pdl_ids, vup_linkedin_urls)
      - name: fbf_id
        sql: fbf_id
        type: string
        description: "DEPRECATED: Use vup_fbf_ids junction table for many-to-many relationship"

      # DEPRECATED: Use junction tables instead
      - name: pdl_id
        sql: pdl_id
        type: string
        description: "DEPRECATED: Use vup_pdl_ids junction table for many-to-many relationship"

      - name: first_name
        sql: first_name
        type: string

      - name: last_name
        sql: last_name
        type: string

      # DEPRECATED: Use junction tables instead
      - name: linkedin_url
        sql: linkedin_url
        type: string
        description: "DEPRECATED: Use vup_linkedin_urls junction table for many-to-many relationship"

      - name: street_address
        sql: street_address
        type: string

      - name: address_line_2
        sql: address_line_2
        type: string

      - name: locality
        sql: locality
        type: string

      - name: region
        sql: region
        type: string

      - name: country
        sql: country
        type: string

      - name: zip
        sql: zip
        type: string

      - name: gender
        sql: gender
        type: string

      - name: data_source
        sql: data_source
        type: string

      - name: dataset_version
        sql: dataset_version
        type: string

      - name: created_at
        sql: created_at
        type: string

      - name: updated_at
        sql: updated_at
        type: string

    measures:
      - name: count
        type: count_distinct
        description: "Total number of distinct people"
        sql: vup_id
      
      # ENG-1914: Deduplication measures
      - name: active_count
        type: count_distinct
        sql: "CASE WHEN {CUBE}.merged_into_vup_id IS NULL THEN {CUBE}.vup_id END"
        description: "Count of active persons (excluding merged records)"
      
      - name: merged_count
        type: count_distinct
        sql: "CASE WHEN {CUBE}.merged_into_vup_id IS NOT NULL THEN {CUBE}.vup_id END"
        description: "Count of persons that were merged into other records"
    
    # ENG-1914: Active persons segment
    segments:
      - name: active_persons
        sql: "{CUBE}.merged_into_vup_id IS NULL"
        description: "Filter to only active person records (not merged)"
