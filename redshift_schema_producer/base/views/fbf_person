CREATE
OR REPLACE VIEW "dev"."base".fbf_person AS WITH latest_partition AS (
    SELECT
        year,
        month
    FROM
        "dev"."raw".universal_person
    ORDER BY
        year DESC,
        month DESC
    LIMIT
        1
)
SELECT
    up_id as id,
    NULLIF(LOWER(first_name), '') as first_name,
    NULLIF(LOWER(last_name), '') as last_name,
    NULLIF(mobile_phone, '') as mobile_phone,
    CASE
    WHEN direct_number = '' THEN NULL
    ELSE SPLIT_TO_ARRAY(direct_number, ',') END as direct_number,
    CASE
    WHEN personal_phone = '' THEN NULL
    ELSE SPLIT_TO_ARRAY(personal_phone, ',') END as personal_phone,
    NULLIF(linkedin_url, '') as linkedin_url,
    NULLIF(LOWER(personal_address), '') as street_address,
    NULLIF(LOWER(personal_address_2), '') as address_line_2,
    NULLIF(LOWER(personal_city), '') as locality,
    NULLIF(LOWER(personal_state), '') as
region
,
    NULLIF(LOWER(personal_zip), '') as zip,
    NULLIF(LOWER(personal_zip4), '') as zip4,
    NULLIF(LOWER(personal_emails), '') as personal_email,
    NULLIF(LOWER(additional_personal_emails), '') as additional_personal_emails,
    NULLIF(LOWER(gender), '') as gender,
    NULLIF(LOWER(age_range), '') as age_range,
    NULLIF(LOWER(married), '') as married,
    NULLIF(LOWER(children), '') as children,
    NULLIF(LOWER(income_range), '') as income_range,
    NULLIF(LOWER(net_worth), '') as net_worth,
    NULLIF(LOWER(homeowner), '') as homeowner,
    NULLIF(LOWER(personal_emails_validation_status), '') as personal_emails_validation_status,
    NULLIF(personal_emails_last_seen, NULL),
    NULLIF(last_updated, NULL),
    NULLIF(LOWER(education_history), '') as education_history,
    NULLIF(social_connections, ''),
    NULLIF(LOWER(dpv_code), '') as dpv_code,
    NULLIF(LOWER(contact_country), '') as country,
    TIMESTAMP 'epoch' + job_title_last_updated * INTERVAL '1 second' as job_last_updated,
    a.year || '-' || a.month as dataset_version
FROM
    "dev"."raw".universal_person a,
    latest_partition b
WHERE
    a.year = b.year
    AND a.month = b.month WITH NO SCHEMA BINDING;